# ============================================================================
# –§–ê–ô–õ 2: backend/quiz_app/prompts.py (–°–û–ó–î–ê–ô –ù–û–í–´–ô –§–ê–ô–õ)
# ============================================================================

import random

# ============================================================================
# –®–ê–ë–õ–û–ù–´ –ü–†–û–ú–ü–¢–û–í –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –í–û–ü–†–û–°–û–í
# ============================================================================

# –ö–∞—Ä—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ —Ç–µ–º–∞–º
THEME_IMAGES = {
    'films': ['soviet_cinema', 'hollywood', 'french_cinema'],
    'animals': ['cat', 'tiger', 'elephant', 'panda', 'wolf'],
    'geography': ['mountains', 'rivers', 'cities', 'deserts'],
    'music': ['rock', 'classical', 'jazz', 'pop'],
    'history': ['ancient', 'medieval', 'modern'],
}

# –û–ø–∏—Å–∞–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è LLM
DIFFICULTY_DESCRIPTIONS = {
    'easy': '–û—á–µ–Ω—å –ª—ë–≥–∫–∏–π –≤–æ–ø—Ä–æ—Å, –∏–∑–≤–µ—Å—Ç–Ω—ã–π —à–∏—Ä–æ–∫–æ–π –ø—É–±–ª–∏–∫–µ —Ñ–∞–∫—Ç',
    'medium': '–°—Ä–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å, —Ç—Ä–µ–±—É–µ—Ç –±–∞–∑–æ–≤—ã—Ö –∑–Ω–∞–Ω–∏–π –ø–æ —Ç–µ–º–µ',
    'hard': '–°–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –∑–Ω–∞—Ç–æ–∫–æ–≤, –º–∞–ª–æ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –¥–µ—Ç–∞–ª–∏',
    'very_hard': '–û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å, —Ä–µ–¥–∫–∏–µ —Ñ–∞–∫—Ç—ã, –¥–ª—è —ç–∫—Å–ø–µ—Ä—Ç–æ–≤',
    'fun': '–õ—ë–≥–∫–∏–π —à—É—Ç–æ—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å –¥–ª—è —Ä–∞–∑—Ä—è–¥–∫–∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã',
}


def detect_topic_category(topic_str):
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–µ–º—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º

    Args:
        topic_str: —Å—Ç—Ä–æ–∫–∞ —Å —Ç–µ–º–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–°–æ–≤–µ—Ç—Å–∫–∏–µ —Ñ–∏–ª—å–º—ã")

    Returns:
        str: –∫–∞—Ç–µ–≥–æ—Ä–∏—è ('films', 'animals', –∏ —Ç.–¥.) –∏–ª–∏ 'default'
    """
    topic_lower = topic_str.lower()

    if any(word in topic_lower for word in ['—Ñ–∏–ª—å–º', '–∫–∏–Ω–æ', '–∞–∫—Ç—ë—Ä', '—Ä–µ–∂–∏—Å—Å—ë—Ä', '—Å–µ—Ä–∏–∞–ª']):
        return 'films'
    elif any(word in topic_lower for word in ['–∂–∏–≤–æ—Ç–Ω', '–∑–æ–æ', '—Ñ–∞—É–Ω–∞', '–ø—Ç–∏—Ü', '—Ä—ã–±']):
        return 'animals'
    elif any(word in topic_lower for word in ['–≥–µ–æ–≥—Ä–∞', '—Å—Ç—Ä–∞–Ω', '–≥–æ—Ä–æ–¥', '—Å—Ç–æ–ª–∏—Ü', '—Ä–µ–∫–∞', '–≥–æ—Ä']):
        return 'geography'
    elif any(word in topic_lower for word in ['–º—É–∑—ã–∫', '–ø–µ—Å–Ω', '–≥—Ä—É–ø–ø–∞', '–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', '–∞–ª—å–±–æ–º']):
        return 'music'
    elif any(word in topic_lower for word in ['–∏—Å—Ç–æ—Ä', '–≤–æ–π–Ω', '–≤–µ–∫', '—ç–ø–æ—Ö', '–ø—Ä–∞–≤–∏—Ç–µ–ª']):
        return 'history'

    return 'default'


def build_prompt(topic, count, difficulty_curve, player_count=1):
    """
    –°—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM —Å —É—á—ë—Ç–æ–º —Ç–µ–º—ã, —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤

    Args:
        topic: —Ç–µ–º–∞ –∫–≤–∏–∑–∞
        count: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤
        difficulty_curve: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
        player_count: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)

    Returns:
        str: –≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è OpenAI
    """
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–µ–º—ã
    theme_category = detect_topic_category(topic)

    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º
    if theme_category in THEME_IMAGES:
        available_images = THEME_IMAGES[theme_category]
        image_list = ', '.join([
            f'"/static/images/themes/{theme_category}/{img}.jpg"'
            for img in available_images
        ])

        image_instruction = f"""
–î–û–°–¢–£–ü–ù–´–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø: {image_list}

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –≤—ã–±–µ—Ä–∏ –°–õ–£–ß–ê–ô–ù–û–ï –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞.
–î–æ–±–∞–≤—å –ø–æ–ª–µ "image_url" —Å –æ–¥–Ω–∏–º –∏–∑ —ç—Ç–∏—Ö –ø—É—Ç–µ–π.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ–¥–Ω—É –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–≤–∞–∂–¥—ã –ø–æ–¥—Ä—è–¥.
–ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ —Å–º—ã—Å–ª—É ‚Äî –æ—Å—Ç–∞–≤—å –ø–æ–ª–µ –ø—É—Å—Ç—ã–º.
"""
    else:
        image_instruction = "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –û—Å—Ç–∞–≤—å –ø–æ–ª–µ image_url –ø—É—Å—Ç—ã–º –¥–ª—è –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å–æ–≤."

    # –°—Ç—Ä–æ–∏–º —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    difficulty_requirements = "\n".join([
        f"–í–æ–ø—Ä–æ—Å {i + 1}: {DIFFICULTY_DESCRIPTIONS[diff]}"
        for i, diff in enumerate(difficulty_curve[:count])
    ])

    # –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏–≥—Ä–æ–∫–æ–≤
    player_context = ""
    if player_count >= 8:
        player_context = "\n–ò–≥—Ä–∞ –¥–ª—è –±–æ–ª—å—à–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ (8+ —á–µ–ª–æ–≤–µ–∫), –¥–µ–ª–∞–π –≤–æ–ø—Ä–æ—Å—ã –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º–∏ –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º–∏."
    elif player_count <= 3:
        player_context = "\n–ò–≥—Ä–∞ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–π –≥—Ä—É–ø–ø—ã (2-3 —á–µ–ª–æ–≤–µ–∫–∞), –≤–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–º–∏."

    prompt = f"""–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤–∏—Ç–µ–ª—å –≤–∏–∫—Ç–æ—Ä–∏–Ω –¥–ª—è –¥–æ–º–∞—à–Ω–∏—Ö –∏–≥—Ä.

–¢–ï–ú–ê: "{topic}"
–ö–û–õ–ò–ß–ï–°–¢–í–û –í–û–ü–†–û–°–û–í: {count}
{player_context}

{image_instruction}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ü–û –°–õ–û–ñ–ù–û–°–¢–ò:
{difficulty_requirements}

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê ‚Äî —Å—Ç—Ä–æ–≥–æ JSON:
{{
  "questions": [
    {{
      "text": "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ (–º–∞–∫—Å–∏–º—É–º 200 —Å–∏–º–≤–æ–ª–æ–≤)",
      "choices": ["–í–∞—Ä–∏–∞–Ω—Ç –ê (–º–∞–∫—Å 40 —Å–∏–º–≤–æ–ª–æ–≤)", "–í–∞—Ä–∏–∞–Ω—Ç –ë", "–í–∞—Ä–∏–∞–Ω—Ç –í", "–í–∞—Ä–∏–∞–Ω—Ç –ì"],
      "correct_index": 0,
      "difficulty": "medium",
      "explanation": "–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–¥–æ 300 —Å–∏–º–≤–æ–ª–æ–≤)",
      "image_url": "/static/images/themes/category/image.jpg"
    }}
  ]
}}

–°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê:
1. –†–æ–≤–Ω–æ 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
2. –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞: –¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤
3. –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞: –¥–æ 40 —Å–∏–º–≤–æ–ª–æ–≤ –∫–∞–∂–¥—ã–π
4. correct_index: —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 3 (–∏–Ω–¥–µ–∫—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤ –º–∞—Å—Å–∏–≤–µ choices)
5. –í—Å–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ü–†–ê–í–î–û–ü–û–î–û–ë–ù–´–ú–ò (–Ω–µ –æ—á–µ–≤–∏–¥–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏)
6. –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –£–ù–ò–ö–ê–õ–¨–ù–´–ú–ò
7. explanation: –∫—Ä–∞—Ç–∫–æ–µ (–¥–æ 300 —Å–∏–º–≤–æ–ª–æ–≤) –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º —Ñ–∞–∫—Ç–æ–º
8. difficulty: –æ–¥–Ω–æ –∏–∑ –∑–Ω–∞—á–µ–Ω–∏–π "easy", "medium", "hard", "very_hard", "fun"
9. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤–æ–ø—Ä–æ—Å—ã —Å —Ç–æ—á–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ "–ò—Å—Ç–æ—Ä–∏—è")
10. –î–ª—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ "fun" —Å–æ–∑–¥–∞–≤–∞–π –ª—ë–≥–∫–∏–µ —à—É—Ç–æ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ä–∞–∑—Ä—è–¥–∫–∏

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –í–û–ü–†–û–°–û–í:

–õ—ë–≥–∫–∏–π (easy):
{{
  "text": "–ö–∞–∫–æ–≥–æ —Ü–≤–µ—Ç–∞ –ª–∏—Å—Ç—å—è —É –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –¥–µ—Ä–µ–≤—å–µ–≤ –ª–µ—Ç–æ–º?",
  "choices": ["–ó–µ–ª—ë–Ω–æ–≥–æ", "–ö—Ä–∞—Å–Ω–æ–≥–æ", "–ñ—ë–ª—Ç–æ–≥–æ", "–°–∏–Ω–µ–≥–æ"],
  "correct_index": 0,
  "difficulty": "easy",
  "explanation": "–õ–µ—Ç–æ–º –ª–∏—Å—Ç—å—è –∑–µ–ª—ë–Ω—ã–µ –±–ª–∞–≥–æ–¥–∞—Ä—è —Ö–ª–æ—Ä–æ—Ñ–∏–ª–ª—É, –∫–æ—Ç–æ—Ä—ã–π —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Ñ–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑–µ",
  "image_url": ""
}}

–°—Ä–µ–¥–Ω–∏–π (medium):
{{
  "text": "–ö—Ç–æ –Ω–∞–ø–∏—Å–∞–ª —Ä–æ–º–∞–Ω '–í–æ–π–Ω–∞ –∏ –º–∏—Ä'?",
  "choices": ["–õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π", "–§—ë–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", "–ê–Ω—Ç–æ–Ω –ß–µ—Ö–æ–≤", "–ò–≤–∞–Ω –¢—É—Ä–≥–µ–Ω–µ–≤"],
  "correct_index": 0,
  "difficulty": "medium",
  "explanation": "–õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π –Ω–∞–ø–∏—Å–∞–ª '–í–æ–π–Ω—É –∏ –º–∏—Ä' –≤ 1865-1869 –≥–æ–¥–∞—Ö, —ç—Ç–æ –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ä–æ–º–∞–Ω–æ–≤ –≤ –º–∏—Ä–æ–≤–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ",
  "image_url": ""
}}

–°–ª–æ–∂–Ω—ã–π (hard):
{{
  "text": "–ö–∞–∫–æ–π –∞–∫—Ç—ë—Ä —Å—ã–≥—Ä–∞–ª –≥–ª–∞–≤–Ω—É—é —Ä–æ–ª—å –≤ —Ñ–∏–ª—å–º–µ '–ë–µ—Ä–µ–≥–∏—Å—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è'?",
  "choices": ["–ò–Ω–Ω–æ–∫–µ–Ω—Ç–∏–π –°–º–æ–∫—Ç—É–Ω–æ–≤—Å–∫–∏–π", "–û–ª–µ–≥ –ï—Ñ—Ä–µ–º–æ–≤", "–ï–≤–≥–µ–Ω–∏–π –õ–µ–æ–Ω–æ–≤", "–Æ—Ä–∏–π –ù–∏–∫—É–ª–∏–Ω"],
  "correct_index": 0,
  "difficulty": "hard",
  "explanation": "–ò–Ω–Ω–æ–∫–µ–Ω—Ç–∏–π –°–º–æ–∫—Ç—É–Ω–æ–≤—Å–∫–∏–π –±–ª–µ—Å—Ç—è—â–µ —Å—ã–≥—Ä–∞–ª —Å—Ç—Ä–∞—Ö–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –î–µ—Ç–æ—á–∫–∏–Ω–∞ –≤ —ç—Ç–æ–π –∫–æ–º–µ–¥–∏–∏ 1966 –≥–æ–¥–∞",
  "image_url": "/static/images/themes/films/soviet_cinema.jpg"
}}

–®—É—Ç–æ—á–Ω—ã–π (fun):
{{
  "text": "–°–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ –ó–µ–º–ª–µ, –µ—Å–ª–∏ –Ω–µ —Å—á–∏—Ç–∞—Ç—å —Ç–µ—Ö, –æ –∫–æ—Ç–æ—Ä—ã—Ö –≤—Å–µ –∑–∞–±—ã–ª–∏?",
  "choices": ["7", "5", "6", "42"],
  "correct_index": 0,
  "difficulty": "fun",
  "explanation": "–ù–∞ –ó–µ–º–ª–µ 7 –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–æ–≤, –∏ –º—ã –≤—Å–µ –∏—Ö –ø–æ–º–Ω–∏–º! (—Ö–æ—Ç—è –ê—Ç–ª–∞–Ω—Ç–∏–¥—É –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–±—ã–≤–∞—é—Ç)",
  "image_url": ""
}}

–°–æ–∑–¥–∞–π {count} –≤–æ–ø—Ä–æ—Å–æ–≤ —Å—Ç—Ä–æ–≥–æ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ç–µ–º–µ '{topic}' –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ markdown.
"""

    return prompt


# ============================================================================
# –ú–û–¢–ò–í–ò–†–£–Æ–©–ò–ï –§–†–ê–ó–´ –î–õ–Ø –û–¢–í–ï–¢–û–í
# ============================================================================

# –û–±—ã—á–Ω—ã–µ —Ñ—Ä–∞–∑—ã –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
SUCCESS_REPLIES = {
    'easy': [
        "–õ–µ–≥–∫–æ! ‚ú®",
        "–†–∞–∑–º–∏–Ω–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!",
        "–û—Ç–ª–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º! üëç",
    ],
    'medium': [
        "–û—Ç–ª–∏—á–Ω–æ! ‚ö°",
        "–•–æ—Ä–æ—à–æ –∑–Ω–∞–µ—à—å —Ç–µ–º—É!",
        "–ü—Ä–∞–≤–∏–ª—å–Ω–æ, —Ç–∞–∫ –¥–µ—Ä–∂–∞—Ç—å! üéØ",
    ],
    'hard': [
        "–í–ø–µ—á–∞—Ç–ª—è–µ—Ç! üéØ",
        "–û—Ç–ª–∏—á–Ω—ã–µ –∑–Ω–∞–Ω–∏—è!",
        "–¢—ã –∑–Ω–∞—Ç–æ–∫! üëè",
    ],
    'very_hard': [
        "–ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ! –¢—ã —ç–∫—Å–ø–µ—Ä—Ç! üèÜ",
        "–ö–∞–∫ —Ç—ã —ç—Ç–æ –∑–Ω–∞–ª?! ü§Ø",
        "–§–µ–Ω–æ–º–µ–Ω–∞–ª—å–Ω–æ! üåü",
    ],
    'fun': [
        "–í–µ—Å–µ–ª–æ! üòÑ",
        "–ü—Ä–∞–≤–∏–ª—å–Ω–æ –∏ —Å–º–µ—à–Ω–æ!",
        "–•–∞-—Ö–∞, –º–æ–ª–æ–¥–µ—Ü! üéâ",
    ]
}

FAIL_REPLIES = {
    'easy': [
        "–û–π, —ç—Ç–æ –∂–µ –ª—ë–≥–∫–∏–π! üòÖ",
        "–ë—ã–≤–∞–µ—Ç, –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π!",
        "–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –±—É–¥–µ—Ç –ª—É—á—à–µ!",
    ],
    'medium': [
        "–•–æ—Ä–æ—à–∞—è –ø–æ–ø—ã—Ç–∫–∞!",
        "–ü–æ—á—Ç–∏ —É–≥–∞–¥–∞–ª! üéØ",
        "–ù–∏—á–µ–≥–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º!",
    ],
    'hard': [
        "–°–ª–æ–∂–Ω—ã–π –±—ã–ª, –Ω–∏—á–µ–≥–æ! üí™",
        "–ù–µ –≤—Å–µ–º –¥–∞–Ω–æ —ç—Ç–æ –∑–Ω–∞—Ç—å!",
        "–ó–∞—Ç–æ —Ç–µ–ø–µ—Ä—å –∑–Ω–∞–µ—à—å! üìö",
    ],
    'very_hard': [
        "–≠—Ç–æ –±—ã–ª –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å...",
        "–ú–∞–ª–æ –∫—Ç–æ –∑–Ω–∞–µ—Ç —Ç–∞–∫–æ–µ!",
        "–¢–µ–ø–µ—Ä—å —Ç–æ—á–Ω–æ –∑–∞–ø–æ–º–Ω–∏—à—å! üß†",
    ],
    'fun': [
        "–ù–µ —É–≥–∞–¥–∞–ª —à—É—Ç–∫—É! üòÑ",
        "–ë—ã–≤–∞–µ—Ç! –°–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –ø–æ–≤–µ–∑—ë—Ç!",
        "–ù–∏—á–µ–≥–æ, –ø–æ—Å–º–µ—è–ª–∏—Å—å! üòä",
    ]
}

# –†–µ–¥–∫–∏–µ —Ñ—Ä–∞–∑—ã (1% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
RARE_SUCCESS = [
    "–í–ê–£! –î–∞–∂–µ —è –Ω–µ –±—ã–ª —É–≤–µ—Ä–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ! ü§Ø",
    "–¢—ã —Å–ª—É—á–∞–π–Ω–æ –Ω–µ —á–∏—Ç–∞–ª –º—ã—Å–ª–∏ —Å–æ—Å—Ç–∞–≤–∏—Ç–µ–ª—è? üßô",
    "–≠—Ç–æ... —ç—Ç–æ –±—ã–ª–æ –∏–¥–µ–∞–ª—å–Ω–æ! üëè",
    "Legendary! –¢–∞–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –≤ —É—á–µ–±–Ω–∏–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç! üìñ",
]

RARE_FAILS = [
    "–≠—Ç–æ –±—ã–ª —Ç–µ—Å—Ç, –∏ —Ç—ã –µ–≥–æ... —ç—ç—ç... –ø–æ—á—Ç–∏ –ø—Ä–æ—à—ë–ª ü§£",
    "–ì–¥–µ-—Ç–æ –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –≤—Å–µ–ª–µ–Ω–Ω–æ–π —Ç—ã –æ—Ç–≤–µ—Ç–∏–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ",
    "–ï—Å–ª–∏ —á—Ç–æ ‚Äî —è –Ω–∏–∫–æ–º—É –Ω–µ —Å–∫–∞–∂—É üòè",
    "–ì–æ–≤–æ—Ä—è—Ç, —Å —Ç—Ä–µ—Ç—å–µ–π –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ª—É—á—à–µ... —Ö–æ—Ç—è —ç—Ç–æ —É–∂–µ –ø—è—Ç–∞—è üôÉ",
    "–ó–∞—Ç–æ —Ç–µ–ø–µ—Ä—å —Ç—ã —Ç–æ—á–Ω–æ –∑–∞–ø–æ–º–Ω–∏—à—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç!",
]

# –¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—Ä–∞–∑—ã (–ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º)
TOPIC_SPECIFIC_PHRASES = {
    'films': {
        'success': [
            "–ú–æ–ª–æ–¥–µ—Ü! –î–∞–∂–µ –®—Ç–∏—Ä–ª–∏—Ü –æ—Ü–µ–Ω–∏–ª –±—ã —Ç–∞–∫—É—é —Ç–æ—á–Ω–æ—Å—Ç—å üïµÔ∏è",
            "–ö–∞–∫ –±—É–¥—Ç–æ —Å–∞–º –Ω–∞ —Å—ä—ë–º–∫–∞—Ö –±—ã–ª!",
            "–ù–∞—Å—Ç–æ—è—â–∏–π –∫–∏–Ω–æ–º–∞–Ω! üé¨",
        ],
        'fail': [
            "–ï—Å–ª–∏ –±—ã –ì–∞–π–¥–∞–π —Å–Ω–∏–º–∞–ª –∫–≤–∏–∑-—à–æ—É, —Ç—ã –±—ã –Ω–µ –ø—Ä–æ—à—ë–ª –∫–∞—Å—Ç–∏–Ω–≥ üòÑ",
            "–î–∞–∂–µ –®—É—Ä–∏–∫ –∑–Ω–∞–ª –±—ã –æ—Ç–≤–µ—Ç!",
            "–û–ø–µ—Ä–∞—Ü–∏—è '–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç' –ø—Ä–æ–≤–∞–ª–µ–Ω–∞ üé¨",
        ]
    },
    'music': {
        'success': [
            "–ò–¥–µ–∞–ª—å–Ω–æ–µ –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ —Ç–∞–∫—Ç! üé∂",
            "–ê–±—Å–æ–ª—é—Ç–Ω—ã–π –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Å–ª—É—Ö!",
            "–ù–∞—Å—Ç–æ—è—â–∏–π –º–µ–ª–æ–º–∞–Ω! üéµ",
        ],
        'fail': [
            "–≠—Ç–∞ –Ω–æ—Ç–∞ —è–≤–Ω–æ –Ω–µ –≤ —Ç–≤–æ–µ–π —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ üéµ",
            "–ö–∞–∂–µ—Ç—Å—è, —É –∫–æ–≥–æ-—Ç–æ –Ω–µ—Ç —Å–ª—É—Ö–∞... –∏ –∫ –æ—Ç–≤–µ—Ç–∞–º —Ç–æ–∂–µ üòÖ",
            "–ú–∏–º–æ –Ω–æ—Ç, –º–∏–º–æ –æ—Ç–≤–µ—Ç–∞! üéº",
        ]
    },
    'geography': {
        'success': [
            "–¢–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–Ω–∞–Ω–∏–π! üó∫Ô∏è",
            "–ö–∞–∫ –±—É–¥—Ç–æ GPS –≤ –≥–æ–ª–æ–≤–µ!",
            "–ù–∞—Å—Ç–æ—è—â–∏–π –≥–µ–æ–≥—Ä–∞—Ñ! üåç",
        ],
        'fail': [
            "–ó–∞–±–ª—É–¥–∏–ª—Å—è –≤ –æ—Ç–≤–µ—Ç–∞—Ö üó∫Ô∏è",
            "–≠—Ç–æ –Ω–µ —Ç–∞ –∫–∞—Ä—Ç–∞!",
            "–ö–æ–º–ø–∞—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ —Ç—É–¥–∞ üß≠",
        ]
    },
    'history': {
        'success': [
            "–ö–∞–∫ –±—É–¥—Ç–æ –Ω–∞ –º–∞—à–∏–Ω–µ –≤—Ä–µ–º–µ–Ω–∏ –±—ã–ª! ‚è∞",
            "–ù–∞—Å—Ç–æ—è—â–∏–π –∏—Å—Ç–æ—Ä–∏–∫!",
            "–ó–Ω–∞–µ—à—å –∏—Å—Ç–æ—Ä–∏—é –ª—É—á—à–µ —É—á–µ–±–Ω–∏–∫–æ–≤! üìö",
        ],
        'fail': [
            "–ò—Å—Ç–æ—Ä–∏—è –ø–∏—à–µ—Ç—Å—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º–∏, –Ω–æ –Ω–µ —Ç–æ–±–æ–π üòÑ",
            "–≠—Ç–æ –∏–∑ –¥—Ä—É–≥–æ–π —ç–ø–æ—Ö–∏!",
            "–£—á–µ–±–Ω–∏–∫ –Ω–∞–¥–æ –±—ã–ª–æ –ø–æ—á–∏—Ç–∞—Ç—å! üìñ",
        ]
    },
}


def get_reply(is_correct, difficulty, topic=None):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–æ—Ç–∏–≤–∏—Ä—É—é—â—É—é —Ñ—Ä–∞–∑—É –¥–ª—è –æ—Ç–≤–µ—Ç–∞

    Args:
        is_correct: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ –æ—Ç–≤–µ—Ç
        difficulty: —Å–ª–æ–∂–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–∞
        topic: —Ç–µ–º–∞ –∫–≤–∏–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

    Returns:
        str: —Ñ—Ä–∞–∑–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–≥—Ä–æ–∫—É
    """
    # 1% —à–∞–Ω—Å –Ω–∞ —Ä–µ–¥–∫—É—é —Ñ—Ä–∞–∑—É
    if random.random() < 0.01:
        if is_correct:
            return random.choice(RARE_SUCCESS)
        else:
            return random.choice(RARE_FAILS)

    # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—Ä–∞–∑—ã
    if topic:
        topic_category = detect_topic_category(topic)
        if topic_category in TOPIC_SPECIFIC_PHRASES:
            phrases = TOPIC_SPECIFIC_PHRASES[topic_category]
            phrase_type = 'success' if is_correct else 'fail'
            return random.choice(phrases[phrase_type])

    # –û–±—ã—á–Ω—ã–µ —Ñ—Ä–∞–∑—ã –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    if is_correct:
        return random.choice(SUCCESS_REPLIES.get(difficulty, SUCCESS_REPLIES['medium']))
    else:
        return random.choice(FAIL_REPLIES.get(difficulty, FAIL_REPLIES['medium']))


# ============================================================================
# –ö–†–ò–í–ê–Ø –°–õ–û–ñ–ù–û–°–¢–ò
# ============================================================================

def get_difficulty_curve(total_questions, player_count=1):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫—Ä–∏–≤—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ–ø—Ä–æ—Å–æ–≤

    –õ–æ–≥–∏–∫–∞:
    - –ù–∞—á–∏–Ω–∞–µ–º —Å –ª—ë–≥–∫–æ–≥–æ (—Ä–∞–∑–º–∏–Ω–∫–∞)
    - –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    - –ü–∏–∫ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∫–æ–Ω—Ü–æ–º (very_hard)
    - –§–∏–Ω–∞–ª: —Å–ª–æ–∂–Ω—ã–π ‚Üí fun ‚Üí —Å—Ä–µ–¥–Ω–∏–π (—Ä–∞–∑—Ä—è–¥–∫–∞ ‚Üí –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ)
    - –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤

    Args:
        total_questions: –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤
        player_count: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤

    Returns:
        list: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π ['easy', 'medium', 'hard', ...]
    """
    if total_questions <= 5:
        # –ö–æ—Ä–æ—Ç–∫–∏–π –∫–≤–∏–∑
        base_curve = ["easy", "medium", "hard", "hard", "fun"]
    else:
        # –î–ª–∏–Ω–Ω—ã–π –∫–≤–∏–∑
        base_curve = ["easy"]  # —Ä–∞–∑–º–∏–Ω–∫–∞
        middle = total_questions - 4

        for i in range(middle):
            progress = i / middle
            if progress < 0.3:
                base_curve.append("medium")
            elif progress < 0.7:
                base_curve.append("hard")
            else:
                base_curve.append("very_hard")  # –ø–∏–∫ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è

        # –§–∏–Ω–∞–ª: –ø–∏–∫ ‚Üí —Ä–∞–∑—Ä—è–¥–∫–∞ ‚Üí –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        base_curve.extend(["very_hard", "fun", "medium"])

    # –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤
    adjusted = adjust_for_players(base_curve, player_count)

    return adjusted[:total_questions]  # –æ–±—Ä–µ–∑–∞–µ–º –¥–æ –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω—ã


def adjust_for_players(curve, player_count):
    """
    –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤

    –õ–æ–≥–∏–∫–∞:
    - –ú–∞–ª–æ –∏–≥—Ä–æ–∫–æ–≤ (1-3): —Å–Ω–∏–∂–∞–µ–º —Å–ª–æ–∂–Ω–æ—Å—Ç—å (hard ‚Üí medium)
    - –°—Ä–µ–¥–Ω—è—è –≥—Ä—É–ø–ø–∞ (4-7): —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫—Ä–∏–≤–∞—è
    - –ú–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–æ–≤ (8+): –¥–æ–±–∞–≤–ª—è–µ–º –≤—ã–∑–æ–≤ (extra very_hard)

    Args:
        curve: –±–∞–∑–æ–≤–∞—è –∫—Ä–∏–≤–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        player_count: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤

    Returns:
        list: —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫—Ä–∏–≤–∞—è
    """
    adjusted = curve.copy()

    if player_count >= 8:
        # –ú–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–æ–≤ ‚Üí –¥–æ–±–∞–≤–ª—è–µ–º –≤—ã–∑–æ–≤
        insert_pos = len(adjusted) // 2
        adjusted.insert(insert_pos, "very_hard")

    elif player_count <= 3:
        # –ú–∞–ª–æ –∏–≥—Ä–æ–∫–æ–≤ ‚Üí —Å–º—è–≥—á–∞–µ–º
        adjusted = [
            "medium" if diff == "hard" else
            "hard" if diff == "very_hard" else
            diff
            for diff in adjusted
        ]

    elif player_count >= 5:
        # –°—Ä–µ–¥–Ω—è—è –≥—Ä—É–ø–ø–∞ ‚Üí –æ–¥–∏–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π hard –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ
        insert_pos = len(adjusted) // 3
        adjusted.insert(insert_pos, "hard")

    return adjusted